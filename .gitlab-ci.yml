include:
  - project: SocialGouv/gitlab-ci-yml
    file: /autodevops.yml
    ref: v17.3.0

variables:
  AUTO_DEVOPS_RELEASE_AUTO: "ðŸ”–"
  AUTO_DEVOPS_PRODUCTION_AUTO: "ðŸš€"
  NOTIFY_DISABLED: 1

stages:
  - Install
  - Code Quality
  - Registration
  - Release
  - Deploy
  - e2e

Lint:
  rules:
    - when: never

Register image:
  extends: .autodevops_register_image
  variables:
    DOCKER_BUILD_ARGS: >-
      --shm-size 512M
    IMAGE_NAME: $CI_REGISTRY_IMAGE/app

# e2e tests need a running API so we use the built image as a gitlab service
Tests e2e:
  stage: e2e
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  except:
    refs:
      - master
  variables:
    PGHOST: medledevserver.postgres.database.azure.com
    DATABASE_URL: postgres://user_${CI_COMMIT_SHORT_SHA}%40${PGHOST}:pass_${CI_COMMIT_SHORT_SHA}@${PGHOST}/autodevops_${CI_COMMIT_SHORT_SHA}?ssl=true
    API_URL: http://api:3000
    NODE_ENV: staging
    POSTGRES_SSL: "true"
  services:
    - name: $CI_REGISTRY_IMAGE/app:$CI_COMMIT_SHA
      alias: api
  script:
    - yarn migrate:latest
    - yarn seed:run:staging
    - yarn test
