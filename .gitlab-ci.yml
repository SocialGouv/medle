include:
   - project: SocialGouv/gitlab-ci-yml
     file: /autodevops_simple_app.yml
     ref: v7.3.2

variables:
   PROJECT: "medle"
   HELM_CHART_VERSION: "3.0.1"
   VALUES_FILE: ./.k8s/app.values.yml

Create Azure DB (dev):
   stage: "Deploy"
   image: "registry.gitlab.factory.social.gouv.fr/socialgouv/docker/azure-db:830864c0b7b1b53485c81e993477e0b465ac3716"
   allow_failure: true
   only:
      - branches
   except:
      - master
   variables:
      NEW_DB_NAME: db_${CI_COMMIT_SHORT_SHA}
      NEW_USER: user_${CI_COMMIT_SHORT_SHA}@${PGHOST}
      NEW_PASSWORD: pass_${CI_COMMIT_SHORT_SHA}
   script:
      - create-db-user

Migrate Azure DB:
   stage: Notify Finished Deployment
   image: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
   variables:
      NODE_ENV: development
      DATABASE_URL: postgres://user_${CI_COMMIT_SHORT_SHA}%40${PGHOST}:pass_${CI_COMMIT_SHORT_SHA}@${PGHOST}/db_${CI_COMMIT_SHORT_SHA}?ssl=true
   only:
      - branches
   except:
      - master
   needs:
      - Build
      - Register image
      - Create Azure DB (dev)
      - Deploy app (dev)
   script:
      - cd /app
      - yarn run migrate:latest
      - yarn run seed:run

Drop Azure DB (dev):
   stage: "Clean Up"
   image: "registry.gitlab.factory.social.gouv.fr/socialgouv/docker/azure-db:830864c0b7b1b53485c81e993477e0b465ac3716"
   when: manual
   allow_failure: true
   only:
      - branches
   except:
      - master
   variables:
      DROP_DATABASE: db_${CI_COMMIT_SHORT_SHA}
      DROP_USER: user_${CI_COMMIT_SHORT_SHA}@${PGHOST}
   environment:
      name: review/${CI_COMMIT_REF_NAME}-dev
      action: stop
   script:
      - drop-db-user
